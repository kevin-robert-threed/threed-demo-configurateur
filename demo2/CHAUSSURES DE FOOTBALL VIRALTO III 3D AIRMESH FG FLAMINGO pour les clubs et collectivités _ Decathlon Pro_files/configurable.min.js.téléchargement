define(['jquery','underscore','mage/template','mage/translate','priceUtils','priceBox','jquery/ui','jquery/jquery.parsequery','Decathlonpro_QtyIncrement/js/view/product/view/qty_change'],function($,_,mageTemplate,$t,priceUtils,qtyChange){'use strict';$.widget('mage.configurable',{options:{superSelector:'.super-attribute-select',selectSimpleProduct:'[name="selected_configurable_option"]',priceHolderSelector:'.product-add-form .pricebox',spConfig:{},isSaleable:{},productTypeId:{},state:{},priceFormat:{},optionTemplate:'<%- data.label %>'+'<% if (typeof data.finalPrice.value !== "undefined") { %>'+' <%- data.finalPrice.formatted %>'+'<% } %>',mediaGallerySelector:'[data-gallery-role=gallery-placeholder]',mediaGalleryInitial:null,slyOldPriceSelector:'.sly-old-price',normalPriceLabelSelector:'.normal-price .price-label',gallerySwitchStrategy:'replace',tierPriceTemplateSelector:'#tier-prices-template',tierPriceBlockSelector:'[data-role="tier-price-block"]',tierPriceTemplate:''},_create:function(){this._initializeOptions();this._overrideDefaults();this._setupChangeEvents();this._fillState();this._setChildSettings();this._configureForValues();$(this.element).trigger('configurable.initialized');this._addStockStatus();if(this.options.isSaleable==0&&this.options.productTypeId==='configurable'){let select_collection=$('select.product-custom-option').toArray();select_collection.forEach((item)=>{$('select#'+item.id).prop('selectedIndex',1);$('select#'+item.id).change();});}},_initializeOptions:function(){var options=this.options,gallery=$(options.mediaGallerySelector),priceBoxOptions=$(this.options.priceHolderSelector).priceBox().priceBox('option').priceConfig||null;if(priceBoxOptions&&priceBoxOptions.optionTemplate){options.optionTemplate=priceBoxOptions.optionTemplate;}
if(priceBoxOptions&&priceBoxOptions.priceFormat){options.priceFormat=priceBoxOptions.priceFormat;}
options.optionTemplate=mageTemplate(options.optionTemplate);options.tierPriceTemplate=$(this.options.tierPriceTemplateSelector).html();options.settings=options.spConfig.containerId?$(options.spConfig.containerId).find(options.superSelector):$(options.superSelector);options.values=options.spConfig.defaultValues||{};options.parentImage=$('[data-role=base-image-container] img').attr('src');this.inputSimpleProduct=this.element.find(options.selectSimpleProduct);gallery.data('gallery')?this._onGalleryLoaded(gallery):gallery.on('gallery:loaded',this._onGalleryLoaded.bind(this,gallery));},_overrideDefaults:function(){var hashIndex=window.location.href.indexOf('#');if(hashIndex!==-1){this._parseQueryParams(window.location.href.substr(hashIndex+1));}
if(this.options.spConfig.inputsInitialized){this._setValuesByAttribute();}},_parseQueryParams:function(queryString){var queryParams=$.parseQuery({query:queryString});$.each(queryParams,$.proxy(function(key,value){this.options.values[key]=value;},this));},_setValuesByAttribute:function(){this.options.values={};$.each(this.options.settings,$.proxy(function(index,element){var attributeId;if(element.value){attributeId=element.id.replace(/[a-z]*/,'');this.options.values[attributeId]=element.value;}},this));},_setupChangeEvents:function(){$.each(this.options.settings,$.proxy(function(index,element){$(element).on('change',this,this._configure);},this));},_fillState:function(){$.each(this.options.settings,$.proxy(function(index,element){var attributeId=element.id.replace(/[a-z]*/,'');if(attributeId&&this.options.spConfig.attributes[attributeId]){element.config=this.options.spConfig.attributes[attributeId];element.attributeId=attributeId;this.options.state[attributeId]=false;}},this));},_setChildSettings:function(){var childSettings=[],settings=this.options.settings,index=settings.length,option;while(index--){option=settings[index];if(index){option.disabled=true;}else{this._fillSelect(option);}
_.extend(option,{childSettings:childSettings.slice(),prevSetting:settings[index-1],nextSetting:settings[index+1]});childSettings.push(option);}},_configureForValues:function(){if(this.options.values){this.options.settings.each($.proxy(function(index,element){var attributeId=element.attributeId;element.value=this.options.values[attributeId]||'';this._configureElement(element);},this));}},_configure:function(event){event.data._configureElement(this);},_configureElement:function(element){this.simpleProduct=this._getSimpleProductId(element);this.currentSimpleProduct=this._getCurrentSimpleProductId(element);this.currentSimpleProductShippingDelay=this._getCurrentSimpleProductShippingDelay(element);if(element.value){this.options.state[element.config.id]=element.value;if(element.nextSetting){element.nextSetting.disabled=false;this._fillSelect(element.nextSetting);this._resetChildren(element.nextSetting);}else{if(!!document.documentMode){this.inputSimpleProduct.val(element.options[element.selectedIndex].config.allowedProducts[0]);}else{if(element.selectedOptions[0].config.allowedProducts===undefined){this._updateStock(this.currentSimpleProduct);this._updateShippingDelay(this.currentSimpleProductShippingDelay);return;}
this.inputSimpleProduct.val(element.selectedOptions[0].config.allowedProducts[0]);}}}else{this._resetChildren(element);}
this._reloadPrice();this._displayRegularPriceBlock(this.simpleProduct);this._displayTierPriceBlock(this.simpleProduct);this._displayNormalPriceLabel();this._displayShippingBlock(this.simpleProduct);this._updateStock(this.currentSimpleProduct);this._updateShippingDelay(this.currentSimpleProductShippingDelay);},_updateStock:function(optionId){let self=this,message=$("#stock-message"),qty=$('input#qty').val(),button=$("#product-addtocart-button"),stockStatus=$('#product-stock-status');button.attr('disabled',false);if(!self.options.spConfig.decathlonStocks[optionId]){$.ajax({url:'/wazabee/product/stock/',method:'GET',data:{id:optionId},context:this}).done(function(response){if(response.error===false){let stock=parseInt(response.stock);self.changeStockStatus(optionId,stock);self.options.spConfig.stocks[optionId]=stock;self.options.spConfig.decathlonStocks[optionId]=stock;if(message.length&&qty!==null){message.data('stock',stock);message.hide();message.html('');if(qty>stock&&stock!==0){message.html($.mage.__('%1 remaining quantity').replace('%1',stock));message.show();button.attr('disabled',true);}}}});}else{self.changeStockStatus(optionId,self.options.spConfig.decathlonStocks[optionId]);}
if(message.length){stockStatus.hide();message.data('stock',10000);if(self.options.spConfig.stocks[optionId]!=null){stockStatus.show()
message.data('stock',self.options.spConfig.stocks[optionId]);}}
if(message.length&&qty!==null){let stock=parseInt(message.data('stock'));self.changeStockStatus(optionId,stock);message.hide();message.html('');if(qty>stock&&stock!==0){message.html($.mage.__('%1 remaining quantity').replace('%1',stock));message.show();button.attr('disabled',true);}}},changeStockStatus:function(optionId,stock){let stockStatus=$('#product-stock-status'),addToCartContainer=$('#add-to-cart-container'),stockAlertContainer=$('#stock-alert-container'),qtyIncrementContainer=$('#qty-increment-container');$('#stock-alert-form').find('input[name="product_id"]').val(optionId);if(stock!==0){stockStatus.find('.out-of-stock').hide();stockStatus.find('.in-stock').show();addToCartContainer.show();stockAlertContainer.hide();qtyIncrementContainer.find(':button').prop('disabled',false);qtyIncrementContainer.find(':input').prop('disabled',false);}else if(stock===0){stockStatus.find('.out-of-stock').show();stockStatus.find('.in-stock').hide();addToCartContainer.hide();stockAlertContainer.show();qtyIncrementContainer.find(':button').prop('disabled',true);qtyIncrementContainer.find(':input').prop('disabled',true);}},_updateShippingDelay:function(shippingDelay){if(shippingDelay){let stockStatus=$('#product-stock-status'),inStock=stockStatus.find('.in-stock'),shippingDelayText='';if(shippingDelay<=2){shippingDelayText=$t('Available within 1 to 2 weeks');inStock.addClass('manage');inStock.removeClass('no-manage');}else if(shippingDelay<=4){shippingDelayText=$t('Available within 2 to 4 weeks');inStock.removeClass('manage');inStock.addClass('no-manage');}else if(shippingDelay<=6){shippingDelayText=$t('Available within 4 to 6 weeks');inStock.removeClass('manage');inStock.addClass('no-manage');}else{shippingDelayText=$t('Available in more than 6 weeks');inStock.removeClass('manage');inStock.addClass('no-manage');}
inStock.html('<span class="circle"></span>'+shippingDelayText);}},_changeProductImage:function(){var images,initialImages=this.options.mediaGalleryInitial,galleryObject=$(this.options.mediaGallerySelector).data('gallery');if(!galleryObject){return;}
images=this.options.spConfig.images[this.simpleProduct];if(images){images=this._sortImages(images);if(this.options.gallerySwitchStrategy==='prepend'){images=images.concat(initialImages);}
images=$.extend(true,[],images);images=this._setImageIndex(images);galleryObject.updateData(images);$(this.options.mediaGallerySelector).AddFotoramaVideoEvents({selectedOption:this.simpleProduct,dataMergeStrategy:this.options.gallerySwitchStrategy});}else{galleryObject.updateData(initialImages);$(this.options.mediaGallerySelector).AddFotoramaVideoEvents();}},_sortImages:function(images){return _.sortBy(images,function(image){return image.position;});},_setImageIndex:function(images){var length=images.length,i;for(i=0;length>i;i++){images[i].i=i+1;}
return images;},_resetChildren:function(element){if(element.childSettings){_.each(element.childSettings,function(set){set.selectedIndex=0;set.disabled=true;});if(element.config){this.options.state[element.config.id]=false;}}},_fillSelect:function(element){var attributeId=element.id.replace(/[a-z]*/,''),options=this._getAttributeOptions(attributeId),prevConfig,index=1,allowedProducts,i,j,finalPrice=parseFloat(this.options.spConfig.prices.finalPrice.amount),optionFinalPrice,optionPriceDiff,optionPrices=this.options.spConfig.optionPrices,allowedProductMinPrice;this._clearSelect(element);element.options[0]=new Option('','');element.options[0].innerHTML=$t('Choose');prevConfig=false;if(element.prevSetting){prevConfig=element.prevSetting.options[element.prevSetting.selectedIndex];}
if(options){for(i=0;i<options.length;i++){allowedProducts=[];optionPriceDiff=0;if(prevConfig){for(j=0;j<options[i].products.length;j++){if(prevConfig.config&&prevConfig.config.allowedProducts&&prevConfig.config.allowedProducts.indexOf(options[i].products[j])>-1){allowedProducts.push(options[i].products[j]);}}}else{allowedProducts=options[i].products.slice(0);if(typeof allowedProducts[0]!=='undefined'&&typeof optionPrices[allowedProducts[0]]!=='undefined'){allowedProductMinPrice=this._getAllowedProductWithMinPrice(allowedProducts);optionFinalPrice=parseFloat(optionPrices[allowedProductMinPrice].finalPrice.amount);optionPriceDiff=optionFinalPrice-finalPrice;if(optionPriceDiff!==0){options[i].label=options[i].label+' '+priceUtils.formatPrice(optionPriceDiff,this.options.priceFormat,true);}}}
if(allowedProducts.length>0){options[i].allowedProducts=allowedProducts;element.options[index]=new Option(this._getOptionLabel(options[i]),options[i].id);if(typeof options[i].price!=='undefined'){element.options[index].setAttribute('price',options[i].price);}
element.options[index].config=options[i];index++;}else{element.options[index]=new Option(this._getOptionLabel(options[i]),options[i].id);element.options[index].config=options[i];element.options[index].setAttribute('data-out-of-stock',this.options.spConfig.skus[options[i].id]);element.options[index].className='out-of-stock';index++;}}}},_addStockStatus:function(){let options=$('#product-options-wrapper select option');options.each(function(key,element){let text=element.text;if(element.className==='out-of-stock'){element.innerHTML=text+' -  <span class="out-of-stock">'+$t('Unavailable')+'</span>';}})},_getOptionLabel:function(option){return option.label;},_clearSelect:function(element){var i;for(i=element.options.length-1;i>=0;i--){element.remove(i);}},_getAttributeOptions:function(attributeId){if(this.options.spConfig.attributes[attributeId]){return this.options.spConfig.attributes[attributeId].options;}},_reloadPrice:function(){$(this.options.priceHolderSelector).trigger('updatePrice',this._getPrices());},_getPrices:function(){var prices={},elements=_.toArray(this.options.settings),allowedProduct;_.each(elements,function(element){var selected=element.options[element.selectedIndex],config=selected&&selected.config,priceValue={};if(config&&config.allowedProducts.length===1){priceValue=this._calculatePrice(config);}else if(element.value){allowedProduct=this._getAllowedProductWithMinPrice(config.allowedProducts);priceValue=this._calculatePrice({'allowedProducts':[allowedProduct]});}
if(!_.isEmpty(priceValue)){prices.prices=priceValue;}},this);return prices;},_getAllowedProductWithMinPrice:function(allowedProducts){var optionPrices=this.options.spConfig.optionPrices,product={},optionMinPrice,optionFinalPrice;_.each(allowedProducts,function(allowedProduct){optionFinalPrice=parseFloat(optionPrices[allowedProduct].finalPrice.amount);if(_.isEmpty(product)||optionFinalPrice<optionMinPrice){optionMinPrice=optionFinalPrice;product=allowedProduct;}},this);return product;},_calculatePrice:function(config){var displayPrices=$(this.options.priceHolderSelector).priceBox('option').prices,newPrices=this.options.spConfig.optionPrices[_.first(config.allowedProducts)];_.each(displayPrices,function(price,code){if(newPrices[code]){displayPrices[code].amount=newPrices[code].amount-displayPrices[code].amount;}});return displayPrices;},_getCurrentSimpleProductId:function(element){var allOptions=element.config.options,value=element.value,config;config=_.filter(allOptions,function(option){return option.id===value;});config=_.first(config);return _.isEmpty(config)?undefined:_.first(config.current_products);},_getCurrentSimpleProductShippingDelay:function(element){var allOptions=element.config.options,value=element.value,config;config=_.filter(allOptions,function(option){return option.id===value;});config=_.first(config);return _.isEmpty(config)?undefined:_.first(config.shipping_delay);},_getSimpleProductId:function(element){var allOptions=element.config.options,value=element.value,config;config=_.filter(allOptions,function(option){return option.id===value;});config=_.first(config);return _.isEmpty(config)?undefined:_.first(config.allowedProducts);},_displayRegularPriceBlock:function(optionId){var shouldBeShown=true;_.each(this.options.settings,function(element){if(element.value===''){shouldBeShown=false;}});if(shouldBeShown&&this.options.spConfig.optionPrices[optionId].oldPrice.amount!==this.options.spConfig.optionPrices[optionId].finalPrice.amount){$(this.options.slyOldPriceSelector).show();}else{$(this.options.slyOldPriceSelector).hide();}
$(document).trigger('updateMsrpPriceBlock',[optionId,this.options.spConfig.optionPrices]);},_displayNormalPriceLabel:function(){var shouldBeShown=false;_.each(this.options.settings,function(element){if(element.value===''){shouldBeShown=true;}});if(shouldBeShown){$(this.options.normalPriceLabelSelector).show();}else{$(this.options.normalPriceLabelSelector).hide();}},_onGalleryLoaded:function(element){var galleryObject=element.data('gallery');this.options.mediaGalleryInitial=galleryObject.returnCurrentImages();},_displayTierPriceBlock:function(optionId){var options,tierPriceHtml;$('#tier-price-block').hide();$('.minicart-description-table').html('');if(typeof optionId!='undefined'&&this.options.spConfig.optionPrices[optionId].tierPrices!=[]){options=this.options.spConfig.optionPrices[optionId];if(this.options.tierPriceTemplate){tierPriceHtml=mageTemplate(this.options.tierPriceTemplate,{'tierPrices':options.tierPrices,'$t':$t,'currencyFormat':this.options.spConfig.currencyFormat,'priceUtils':priceUtils});$(this.options.tierPriceBlockSelector).html(tierPriceHtml).show();}
let quantity=$('#qty').val();let optionPrices=this.options.spConfig.optionPrices[optionId];let finalPrice=optionPrices.finalPrice['amount'];let basePrice=optionPrices.basePrice['amount'];if(optionPrices!=null){if(optionPrices.tierPrices.length>0){let tierPrice=null;let activeTierPrice=null;let table='<div class="toggle-desc-table"><span>'+$.mage.__("Tier price table")+'</span></div>'+'<table class="description-table">'+'<thead>'+'<tr>'+'<th class="t-left">'+$.mage.__('Quantity')+'</th>'+'<th  class="t-left">'+$.mage.__('Price without tax')+'</th>'+'<th  class="t-left">'+$.mage.__('Price with tax')+'</th>'+'<th  class="t-left">'+$.mage.__('% Discount')+'</th>'+'</tr>'+'</thead>'+'<tbody>'+'<tr>'+'<td class="t-left" qty="1">'+$.mage.__('Single')+'</td>'+'<td>'+basePrice.toFixed(2)+' €</td>'+'<td>'+finalPrice.toFixed(2)+' €</td>'+'<td class="t-center">/</td>'+'</tr>';$.each(optionPrices.tierPrices,function(key,_tierPrice){table+='<tr>'+'<td class="t-left" qty="'+_tierPrice.qty+'">'+_tierPrice.qty+'</td>'+'<td>'+_tierPrice.priceHt.toFixed(2)+' €</td>'+'<td>'+_tierPrice.price.toFixed(2)+' €</td>'+'<td class="promo t-center">'+_tierPrice.percentage+' %</td>'+'</tr>';if(tierPrice==null){tierPrice=_tierPrice;}
if(quantity<_tierPrice.qty&&quantity>=tierPrice.qty){activeTierPrice=tierPrice;tierPrice=_tierPrice;}
if(quantity<=_tierPrice.qty&&quantity>=tierPrice.qty){activeTierPrice=_tierPrice;tierPrice=_tierPrice;}
if(quantity>_tierPrice.qty&&quantity>tierPrice.qty){activeTierPrice=_tierPrice;tierPrice=_tierPrice;}});if(activeTierPrice==null){let unitPrice=finalPrice.toFixed(2);let unitPriceText=$.mage.__('Unit Price')+$.mage.__(' : %1 € TTC').replace('%1',unitPrice);$('.unit-price').text(unitPriceText);$('.unit-price').attr('unit-price',unitPrice+'&nbsp;€ TTC');}
let spanElement;let divElement;let divElement2;let firstUse=false;if($('#tier-price-block')[0]==undefined){spanElement=$('<span />').attr({'className':'upsell-label','id':'tier-price-block'});divElement=$('<div />').attr({'id':'tier-price-div'});divElement2=$('<div />').attr({'id':'tier-price-div2'});spanElement.append(divElement);spanElement.append(divElement2);firstUse=true;}else{spanElement=$('#tier-price-block');divElement=$('#tier-price-div');divElement2=$('#tier-price-div2');spanElement.hide();}
if(activeTierPrice!=null&&$('#qty').val()>=activeTierPrice.qty){let unitPrice=activeTierPrice.price.toString().match(/^-?\d+(?:\.\d{0,2})?/)[0];let total=parseFloat(unitPrice)*parseFloat($('#qty').val());let originalTotal=parseFloat(finalPrice)*parseFloat($('#qty').val());let discount=originalTotal-total;let unitPriceText=$.mage.__('Unit Price')+$.mage.__(' : %1 € TTC').replace('%1',unitPrice);$('.unit-price').text(unitPriceText);$('.unit-price').attr('unit-price',unitPrice+'&nbsp;€ TTC');$('.total-price').text(total.toString().match(/^-?\d+(?:\.\d{0,2})?/)[0]+' € TTC');let savingText=$.mage.__('You already save %1 €.').replace('%1',discount.toString().match(/^-?\d+(?:\.\d{0,2})?/)[0]);divElement2.html(savingText);divElement2.show();}else{divElement2.hide();}
if($('#qty').val()<=tierPrice.qty){let diff=(tierPrice.qty-$('#qty').val());if(diff>0){let message=$.mage.__('More than %1 to get %2').replace('%1',parseInt(diff)).replace('%2','-'+tierPrice.percentage+' %');divElement.html(message);divElement.show();}else{divElement.hide();}}
if(activeTierPrice==tierPrice){divElement.hide();}
if(firstUse){$('.unit-price').before(spanElement);firstUse=false;}else{spanElement.show();}
table+='</tbody></table>';$('.minicart-description-table').html(table);}else{let originalTotal=parseFloat(finalPrice)*parseFloat($('#qty').val());$('.total-price').text(originalTotal.toString().match(/^-?\d+(?:\.\d{0,2})?/)[0]+' € TTC');}}else{let originalTotal=parseFloat(finalPrice)*parseFloat($('#qty').val());$('.total-price').text(originalTotal.toString().match(/^-?\d+(?:\.\d{0,2})?/)[0]+' € TTC');}}else{$(this.options.tierPriceBlockSelector).hide();}},_displayShippingBlock:function(optionId){$('.shipping-delay-configurable').hide();if(typeof optionId!='undefined'&&this.options.spConfig.shipping_delay[optionId]!=null&&this.options.spConfig.shipping_delay[optionId]!=''){$('.shipping-delay-configurable').show();let shippingDelayText=$.mage.__('planned send to %1').replace('%1',this.options.spConfig.shipping_delay[optionId]);$('.shipping-delay-configurable').html('<span class="icon-home_delivery">'+shippingDelayText+'</span>');}}});return $.mage.configurable;});